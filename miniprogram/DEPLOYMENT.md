# 微信小程序前端部署指南

## 部署流程概览

```
配置 API 地址 → 构建生产版本 → 微信平台配置 → 上传代码 → 提交审核 → 发布上线
```

---

## 第一步：配置生产环境 API 地址

### 方式一：直接修改（简单）

编辑 `src/utils/request.ts`：

```typescript
// 将 API_BASE_URL 改为你的生产环境地址
const API_BASE_URL = 'https://your-domain.com'  // 改这里
```

### 方式二：使用环境变量（推荐）

#### 1. 编辑生产环境配置

编辑 `config/prod.ts`：

```typescript
export default defineConfig({
  env: {
    NODE_ENV: '"production"',
    API_BASE_URL: '"https://your-domain.com"'  // 改这里
  },
  // ... 其他配置
})
```

#### 2. 修改 request.ts 使用环境变量

编辑 `src/utils/request.ts`：

```typescript
// 从环境变量读取 API 地址
const API_BASE_URL = process.env.API_BASE_URL || 'http://localhost:8000'
```

---

## 第二步：构建生产版本

### 1. 安装依赖（如果还没安装）

```bash
cd miniprogram

# 使用 pnpm（推荐）
pnpm install

# 或使用 npm
npm install
```

### 2. 构建生产版本

```bash
# 构建微信小程序
pnpm run build:weapp

# 或使用 npm
npm run build:weapp
```

构建完成后，代码会输出到 `dist` 目录。

### 3. 验证构建结果

```bash
# 检查 dist 目录
ls -la dist/

# 应该看到以下文件
# - app.js
# - app.json
# - app.wxss
# - pages/
# - components/
# - ...
```

---

## 第三步：微信公众平台配置

### 1. 登录微信公众平台

访问：https://mp.weixin.qq.com/

使用小程序管理员账号登录。

### 2. 获取 AppID 和 AppSecret

**位置**：开发 → 开发管理 → 开发设置

1. **AppID**：直接显示，复制保存
2. **AppSecret**：
   - 点击"生成"按钮
   - 使用管理员微信扫码确认
   - 复制并保存（只显示一次）

⚠️ **重要**：将 AppID 和 AppSecret 配置到后端的 `.env` 文件中：

```env
WECHAT_APP_ID=你的AppID
WECHAT_APP_SECRET=你的AppSecret
```

### 3. 配置服务器域名

**位置**：开发 → 开发管理 → 开发设置 → 服务器域名

配置以下域名（必须是 HTTPS）：

```
request 合法域名：
https://your-domain.com

uploadFile 合法域名：
https://your-domain.com

downloadFile 合法域名：
https://your-domain.com
```

⚠️ **注意事项**：
- 域名必须已备案（中国大陆服务器）
- 必须使用 HTTPS（不能是 HTTP）
- 不能使用 IP 地址
- 不能带端口号
- 每月只能修改 5 次

### 4. 配置业务域名（可选）

如果小程序中有 web-view 组件，需要配置业务域名。

**位置**：开发 → 开发管理 → 开发设置 → 业务域名

---

## 第四步：使用微信开发者工具上传

### 1. 下载并安装微信开发者工具

下载地址：https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html

选择对应系统版本下载安装。

### 2. 打开项目

1. 启动微信开发者工具
2. 点击"导入项目"或"+"
3. 填写项目信息：
   - **项目目录**：选择 `miniprogram/dist` 目录（⚠️ 是 dist 目录，不是 miniprogram 目录）
   - **AppID**：填入你的小程序 AppID
   - **项目名称**：随意填写
4. 点击"导入"

### 3. 预览测试

在开发者工具中：

1. 点击顶部"预览"按钮
2. 使用手机微信扫码
3. 在真机上测试所有功能：
   - ✅ 首页轮播图显示
   - ✅ 赛事列表显示
   - ✅ 赛事详情页面
   - ✅ 图片加载正常
   - ✅ 微信登录功能
   - ✅ 客服二维码显示

### 4. 上传代码

确认测试无误后：

1. 点击顶部"上传"按钮
2. 填写版本信息：
   - **版本号**：如 1.0.0
   - **项目备注**：如"首次发布"或"修复图片加载问题"
3. 点击"上传"

上传成功后，会在微信公众平台看到"开发版本"。

---

## 第五步：提交审核

### 1. 登录微信公众平台

访问：https://mp.weixin.qq.com/

### 2. 进入版本管理

**位置**：管理 → 版本管理

你会看到三个版本区域：
- **开发版本**：刚上传的版本
- **审核版本**：正在审核的版本
- **线上版本**：已发布的版本

### 3. 提交审核

在"开发版本"中：

1. 点击"提交审核"按钮
2. 填写审核信息

#### 配置项说明

**1. 功能页面**

至少添加一个功能页面：

```
页面标题：首页
页面路径：pages/index/index
页面截图：上传首页截图（必须是真机截图）
```

可以添加多个页面：
- 首页：pages/index/index
- 赛事详情：pages/event-detail/index
- 个人中心：pages/profile/index

**2. 测试账号（如果需要）**

如果小程序需要登录才能使用，提供测试账号：

```
账号：test_user
密码：test123456
```

**3. 类目选择**

选择合适的类目，例如：
- 体育 → 体育资讯
- 工具 → 信息查询

**4. 标签**

添加相关标签：足球、赛事、体育

**5. 功能描述**

详细描述小程序功能：

```
宝利足球赛事通是一款足球赛事信息查询小程序。

主要功能：
1. 查看最新足球赛事信息
2. 浏览赛事详情和分析
3. 联系客服获取更多信息

使用说明：
1. 打开小程序即可查看赛事列表
2. 点击赛事卡片查看详情
3. 在个人中心可以修改昵称
4. 赛事详情页底部可以联系客服
```

**6. 隐私政策**

如果收集用户信息，需要提供隐私政策链接。

### 4. 提交

填写完成后，点击"提交审核"。

---

## 第六步：等待审核

### 审核时间

- 通常 1-7 个工作日
- 首次提交可能需要更长时间
- 可以在"审核版本"中查看审核进度

### 审核状态

- **审核中**：正在审核
- **审核通过**：可以发布
- **审核失败**：查看失败原因，修改后重新提交

### 常见审核失败原因

1. **服务器域名未配置**
   - 解决：在微信公众平台配置服务器域名

2. **功能与描述不符**
   - 解决：确保功能描述准确

3. **缺少必要资质**
   - 解决：根据类目要求提供相应资质

4. **用户隐私保护不足**
   - 解决：添加隐私政策，明确说明数据使用

5. **内容违规**
   - 解决：检查内容是否符合规范

---

## 第七步：发布上线

### 审核通过后

1. 登录微信公众平台
2. 进入"管理 → 版本管理"
3. 在"审核版本"中点击"发布"
4. 确认发布

### 发布后

- 小程序正式上线
- 用户可以搜索到你的小程序
- 可以在"线上版本"中看到当前版本

---

## 版本更新

### 更新流程

```
修改代码 → 构建 → 上传 → 提交审核 → 发布
```

### 详细步骤

1. **修改代码**
   ```bash
   # 修改代码后
   cd miniprogram
   pnpm run build:weapp
   ```

2. **上传新版本**
   - 打开微信开发者工具
   - 导入 `dist` 目录
   - 点击"上传"
   - 填写新版本号（如 1.0.1）

3. **提交审核**
   - 在微信公众平台提交审核
   - 填写更新说明

4. **发布**
   - 审核通过后发布

### 版本号规范

建议使用语义化版本号：

- **主版本号**：重大功能变更（1.0.0 → 2.0.0）
- **次版本号**：新增功能（1.0.0 → 1.1.0）
- **修订号**：Bug 修复（1.0.0 → 1.0.1）

---

## 快速部署脚本

创建 `deploy.sh` 脚本：

```bash
#!/bin/bash

echo "开始构建小程序..."

# 进入小程序目录
cd miniprogram

# 安装依赖（如果需要）
# pnpm install

# 构建生产版本
pnpm run build:weapp

echo "构建完成！"
echo "请使用微信开发者工具打开 miniprogram/dist 目录"
echo "然后点击上传按钮上传代码"
```

使用方法：

```bash
chmod +x deploy.sh
./deploy.sh
```

---

## 环境配置对照表

| 环境 | API 地址 | 配置位置 |
|------|---------|---------|
| 开发环境 | http://localhost:8000 | src/utils/request.ts |
| 测试环境 | https://test.your-domain.com | config/prod.ts |
| 生产环境 | https://your-domain.com | config/prod.ts |

---

## 常见问题

### 1. 构建失败

**问题**：运行 `pnpm run build:weapp` 报错

**解决**：
```bash
# 清理缓存
rm -rf node_modules
rm -rf dist

# 重新安装依赖
pnpm install

# 重新构建
pnpm run build:weapp
```

### 2. 上传失败

**问题**：微信开发者工具上传失败

**解决**：
- 检查是否选择了正确的 AppID
- 检查是否有上传权限（需要是开发者或管理员）
- 检查网络连接
- 重启微信开发者工具

### 3. 真机预览白屏

**问题**：真机预览时页面白屏

**解决**：
- 检查 API 地址是否正确
- 检查服务器域名是否配置
- 检查后端服务是否正常运行
- 查看控制台错误信息

### 4. 图片不显示

**问题**：真机上图片无法显示

**解决**：
- 确保使用 HTTPS
- 确保图片 URL 域名已配置
- 检查图片路径是否正确
- 检查后端静态文件服务是否正常

### 5. 微信登录失败

**问题**：点击登录没有反应

**解决**：
- 检查 AppID 和 AppSecret 是否正确
- 检查后端 `/api/auth/login` 接口是否正常
- 查看控制台错误信息
- 确保在真机上测试（模拟器可能不支持）

---

## 部署检查清单

### 构建前
- [ ] API 地址已修改为生产环境
- [ ] 代码已提交到 Git
- [ ] 依赖已安装完成

### 微信平台配置
- [ ] 已获取 AppID 和 AppSecret
- [ ] 服务器域名已配置（HTTPS）
- [ ] 后端 .env 文件已配置 AppID 和 AppSecret

### 构建和上传
- [ ] 生产版本构建成功
- [ ] 微信开发者工具已安装
- [ ] 代码已上传到微信平台

### 测试
- [ ] 真机预览测试通过
- [ ] 所有功能正常
- [ ] 图片加载正常
- [ ] 微信登录正常

### 审核和发布
- [ ] 审核信息已填写完整
- [ ] 功能截图已上传
- [ ] 已提交审核
- [ ] 审核通过并发布

---

## 技巧和建议

### 1. 使用体验版测试

在正式发布前，可以设置体验版：

1. 在微信公众平台添加体验成员
2. 体验成员扫码即可使用体验版
3. 体验版不需要审核，可以快速测试

### 2. 分阶段发布

首次发布建议：

1. 先发布基础功能
2. 审核通过后再逐步添加新功能
3. 避免一次性提交过多功能

### 3. 保留开发版本

- 每次上传前做好备份
- 保留多个开发版本用于回滚
- 使用 Git 管理代码版本

### 4. 监控线上问题

发布后：

- 关注用户反馈
- 查看后台错误日志
- 及时修复问题并更新

---

## 相关文档

- [微信小程序官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [Taro 官方文档](https://taro-docs.jd.com/)
- [项目 README](../README.md)
- [后端部署指南](../DEPLOYMENT_GUIDE.md)
- [Docker 部署指南](../DOCKER_DEPLOYMENT.md)

---

## 总结

微信小程序部署流程：

1. ✅ **配置 API 地址** - 修改为生产环境地址
2. ✅ **构建生产版本** - `pnpm run build:weapp`
3. ✅ **微信平台配置** - 配置域名和获取 AppID
4. ✅ **上传代码** - 使用微信开发者工具上传
5. ✅ **提交审核** - 填写审核信息并提交
6. ✅ **发布上线** - 审核通过后发布

**重要提醒**：
- 必须使用 HTTPS
- 域名必须在微信平台配置
- AppID 和 AppSecret 必须配置到后端
- 真机测试所有功能

祝你部署顺利！🎉
