# 微信小程序部署文档

## 项目信息

- **项目名称**: 宝利足球赛事通
- **技术栈**: Taro 3.x + React + TypeScript
- **AppID**: wxdce45db8d882173e

## 部署前准备

### 1. 环境要求

- Node.js 16+ 
- pnpm (推荐) 或 npm
- 微信开发者工具

### 2. 微信公众平台配置

登录 [微信公众平台](https://mp.weixin.qq.com/)，完成以下配置：

#### 2.1 服务器域名配置

在 **开发 → 开发管理 → 开发设置 → 服务器域名** 中配置：

**request 合法域名**（必须是 HTTPS）：
```
https://你的后端域名.com
```

**uploadFile 合法域名**（如果需要上传图片）：
```
https://你的后端域名.com
```

**downloadFile 合法域名**（如果需要下载文件）：
```
https://你的后端域名.com
```

> ⚠️ 注意：
> - 域名必须使用 HTTPS 协议
> - 域名必须已备案
> - 每月只能修改 5 次，请谨慎操作

#### 2.2 业务域名配置（可选）

如果小程序内需要打开网页，在 **开发 → 开发管理 → 开发设置 → 业务域名** 中配置。

## 部署步骤

### 第一步：配置生产环境 API 地址

编辑 `miniprogram/config/prod.ts`，修改为你的实际后端域名：

```typescript
export default {
  env: {
    NODE_ENV: '"production"'
  },
  defineConstants: {
    'process.env.API_BASE_URL': '"https://你的后端域名.com"'
  },
  mini: {},
  h5: {}
}
```

> ⚠️ 重要：必须使用 HTTPS 协议，且域名需要在微信公众平台配置

### 第二步：安装依赖

```bash
cd miniprogram
pnpm install
```

### 第三步：构建生产版本

```bash
pnpm run build:weapp
```

构建完成后，代码会输出到 `dist/` 目录。

### 第四步：使用微信开发者工具上传

1. **打开微信开发者工具**
   - 选择"小程序"项目
   - 导入项目

2. **导入项目配置**
   - 项目目录：选择 `miniprogram` 目录（不是 dist 目录）
   - AppID：使用 `wxdce45db8d882173e`（或你自己的 AppID）
   - 项目名称：宝利足球赛事通

3. **检查配置**
   - 确认 `project.config.json` 中的 `miniprogramRoot` 为 `dist/`
   - 确认 `appid` 正确

4. **预览测试**
   - 点击工具栏的"预览"按钮
   - 使用手机微信扫码测试
   - 测试所有功能是否正常

5. **上传代码**
   - 点击工具栏的"上传"按钮
   - 填写版本号（如：1.0.0）
   - 填写项目备注（如：首次发布）
   - 点击"上传"

### 第五步：提交审核

1. **登录微信公众平台**
   - 访问 https://mp.weixin.qq.com/
   - 进入"版本管理"

2. **选择开发版本**
   - 在"开发版本"中找到刚上传的版本
   - 点击"提交审核"

3. **填写审核信息**
   - 配置功能页面路径
   - 填写测试账号（如需要）
   - 上传功能截图
   - 填写版本描述

4. **等待审核**
   - 审核时间通常为 1-7 个工作日
   - 可在"版本管理"中查看审核进度

### 第六步：发布上线

审核通过后：
1. 在"版本管理"中找到"审核通过"的版本
2. 点击"发布"按钮
3. 确认发布

## 版本更新流程

### 1. 修改代码

在 `miniprogram/src/` 目录下修改代码。

### 2. 重新构建

```bash
cd miniprogram
pnpm run build:weapp
```

### 3. 上传新版本

使用微信开发者工具上传，版本号递增（如：1.0.1 → 1.0.2）。

### 4. 提交审核并发布

重复"第五步"和"第六步"。

## 常见问题

### 1. 网络请求失败

**问题**：小程序无法请求后端 API

**解决方案**：
- 检查后端域名是否在微信公众平台配置
- 确认后端使用 HTTPS 协议
- 检查 SSL 证书是否有效
- 在开发者工具中关闭"不校验合法域名"进行测试

### 2. 图片无法显示

**问题**：上传的图片在小程序中无法显示

**解决方案**：
- 确认图片 URL 使用 HTTPS
- 检查图片域名是否在"downloadFile 合法域名"中配置
- 检查图片路径是否正确

### 3. 构建失败

**问题**：执行 `pnpm run build:weapp` 报错

**解决方案**：
```bash
# 清除缓存
rm -rf node_modules
rm -rf dist

# 重新安装依赖
pnpm install

# 重新构建
pnpm run build:weapp
```

### 4. 小程序包太大

**问题**：上传时提示包大小超过限制（2MB）

**解决方案**：
- 压缩图片资源
- 使用分包加载
- 将大图片放到服务器，使用网络图片

### 5. 真机测试与开发工具表现不一致

**解决方案**：
- 使用"预览"功能在真机上测试
- 检查微信版本和基础库版本
- 查看真机调试日志

## 开发环境与生产环境对比

| 项目 | 开发环境 | 生产环境 |
|------|---------|---------|
| 命令 | `pnpm run dev:weapp` | `pnpm run build:weapp` |
| API 地址 | http://localhost:8000 | https://你的域名.com |
| 域名校验 | 可关闭 | 必须开启 |
| 代码压缩 | 否 | 是 |
| Source Map | 是 | 可选 |

## 配置文件说明

### project.config.json

微信开发者工具的项目配置文件：
- `miniprogramRoot`: 小程序代码目录（dist/）
- `appid`: 小程序 AppID
- `setting`: 编译设置

### config/prod.ts

生产环境配置：
- `process.env.API_BASE_URL`: 后端 API 地址

### src/app.config.ts

小程序全局配置：
- `pages`: 页面路径列表
- `window`: 窗口样式
- `tabBar`: 底部导航栏

## 检查清单

部署前请确认：

- [ ] 后端 API 已部署并可访问（HTTPS）
- [ ] 微信公众平台已配置服务器域名
- [ ] `config/prod.ts` 中的 API 地址已修改
- [ ] 执行 `pnpm run build:weapp` 构建成功
- [ ] 微信开发者工具中预览测试通过
- [ ] 所有功能在真机上测试正常
- [ ] 图片、网络请求等资源加载正常
- [ ] AppID 配置正确

## 技术支持

如遇到问题，请检查：
1. 微信开发者工具控制台日志
2. 真机调试日志
3. 后端 API 日志
4. 微信公众平台审核反馈

---

**祝部署顺利！** 🚀
