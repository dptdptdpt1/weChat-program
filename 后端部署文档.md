# åç«¯ API éƒ¨ç½²æ–‡æ¡£

## æŠ€æœ¯æ ˆ

FastAPI + SQLAlchemy + SQLiteï¼ˆæ–‡ä»¶æ•°æ®åº“ï¼Œæ— éœ€å•ç‹¬éƒ¨ç½²ï¼‰

---

## æœåŠ¡å™¨éƒ¨ç½²æµç¨‹

### å‰ç½®è¦æ±‚

- æœåŠ¡å™¨ï¼šUbuntu 20.04+ / CentOS 7+
- å·²å®‰è£… Docker å’Œ Docker Compose
- åŸŸåå·²è§£æåˆ°æœåŠ¡å™¨ IP

---

### 1. ä¸Šä¼ ä»£ç 

```bash
# ä½¿ç”¨ Git
git clone <ä½ çš„ä»“åº“åœ°å€>
cd api

# æˆ–ä½¿ç”¨ SCP
scp -r api/ user@server:/home/user/
ssh user@server
cd /home/user/api
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

```bash
nano .env
```

ä¿®æ”¹ä»¥ä¸‹å†…å®¹ï¼š
```env
WECHAT_APP_ID=ä½ çš„AppID
WECHAT_APP_SECRET=ä½ çš„AppSecret
```

### 3. å¯åŠ¨æœåŠ¡

```bash
docker-compose up -d
docker exec -it football-api python init_db.py
```

### 4. é…ç½® Nginx + HTTPS

```bash
# å®‰è£… Nginx å’Œ SSL è¯ä¹¦å·¥å…·
sudo apt install nginx certbot python3-certbot-nginx -y

# åˆ›å»º Nginx é…ç½®
sudo nano /etc/nginx/sites-available/football-api
```

**é…ç½®å†…å®¹**ï¼š
```nginx
server {
    listen 80;
    server_name api.yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.yourdomain.com;

    ssl_certificate /etc/letsencrypt/live/api.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.yourdomain.com/privkey.pem;
    client_max_body_size 10M;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

**å¯ç”¨é…ç½®**ï¼š
```bash
sudo ln -s /etc/nginx/sites-available/football-api /etc/nginx/sites-enabled/
sudo certbot --nginx -d api.yourdomain.com
sudo nginx -t
sudo systemctl reload nginx
```

### 5. éªŒè¯éƒ¨ç½²

è®¿é—®ä»¥ä¸‹åœ°å€ç¡®è®¤æœåŠ¡æ­£å¸¸ï¼š
- https://api.yourdomain.com/docs
- https://api.yourdomain.com/admin

---

## æ•°æ®å¤‡ä»½

**åˆ›å»ºå¤‡ä»½è„šæœ¬** (`backup.sh`)ï¼š
```bash
#!/bin/bash
BACKUP_DIR="/home/user/backups"
DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR
tar -czf $BACKUP_DIR/api-$DATE.tar.gz data/ uploads/
find $BACKUP_DIR -name "api-*.tar.gz" -mtime +7 -delete
```

**è®¾ç½®å®šæ—¶å¤‡ä»½**ï¼š
```bash
chmod +x backup.sh
crontab -e
# æ·»åŠ ï¼šæ¯å¤©å‡Œæ™¨ 2 ç‚¹å¤‡ä»½
0 2 * * * /home/user/api/backup.sh
```

**æ¢å¤æ•°æ®**ï¼š
```bash
docker-compose down
tar -xzf /home/user/backups/api-20240101_020000.tar.gz
docker-compose up -d
```

---

## æ›´æ–°ä»£ç 

```bash
cd /home/user/api
git pull
docker-compose up -d --build
```

---

## å¸¸ç”¨å‘½ä»¤

```bash
docker-compose logs -f              # æŸ¥çœ‹æ—¥å¿—
docker-compose restart              # é‡å¯æœåŠ¡
docker-compose down                 # åœæ­¢æœåŠ¡
docker exec -it football-api bash   # è¿›å…¥å®¹å™¨
```

---

## å¸¸è§é—®é¢˜

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|---------|
| ç«¯å£è¢«å ç”¨ | ä¿®æ”¹ `docker-compose.yml` ç«¯å£ä¸º `"8001:8000"` |
| æ•°æ®åº“æƒé™é”™è¯¯ | `sudo chown -R 1000:1000 data/` |
| ä¸Šä¼ æ–‡ä»¶å¤±è´¥ | `sudo chown -R www-data:www-data uploads/` |
| SSL è¯ä¹¦è¿‡æœŸ | `sudo certbot renew && sudo systemctl reload nginx` |

---

## éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] `.env` å·²é…ç½®ï¼ˆAppIDã€AppSecretï¼‰
- [ ] æœåŠ¡å·²å¯åŠ¨ï¼ˆ`docker-compose up -d`ï¼‰
- [ ] æ•°æ®åº“å·²åˆå§‹åŒ–ï¼ˆ`python init_db.py`ï¼‰
- [ ] Nginx + HTTPS å·²é…ç½®
- [ ] æœåŠ¡å¯è®¿é—®ï¼ˆ/docsã€/adminï¼‰
- [ ] å¤‡ä»½è„šæœ¬å·²é…ç½®

---

**å®Œæˆï¼** ğŸš€
